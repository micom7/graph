# ТЗ: Веб-редактор графу маршрутів зерносховища

## 1. Мета

Створити веб-додаток для візуального редагування технологічного графу маршрутів (механізми → з'єднання), з подальшим збереженням даних у базу SQL.

---

## 2. Вибір бібліотеки

### Обрано: **React Flow** (`@xyflow/react`)

| Критерій | React Flow | JointJS | Drawflow | Rete.js |
|---|---|---|---|---|
| Іменовані порти (handles) | ✅ | ✅ | частково | ✅ |
| Кастомні вузли | ✅ | ✅ | ✅ | ✅ |
| Напрямок з'єднання | ✅ | ✅ | ✅ | ✅ |
| Чистий JSON експорт | ✅ | складно | ✅ | ✅ |
| Ліцензія | MIT (безкоштовна) | Dual (платна) | MIT | MIT |
| Активна підтримка | ✅ | ✅ | слабка | середня |
| Документація | відмінна | добра | мінімальна | добра |

**React Flow** обраний через найкращу підтримку кастомних вузлів з іменованими портами, чистий React-стек і зручний JSON-формат для імпорту в БД.

---

## 3. Стек технологій

```
Фронтенд:  React 18 + TypeScript + React Flow (@xyflow/react)
Бекенд:    Python 3.11 + FastAPI + asyncpg
База:      PostgreSQL 16
```

---

## 4. Схема бази даних

```sql
-- Типи пристроїв (засувка, норія, транспортер, редлер...)
CREATE TABLE device_types (
    id        SERIAL PRIMARY KEY,
    name      VARCHAR(50) NOT NULL UNIQUE,  -- 'zasuvka', 'noria', 'transporter'
    label     VARCHAR(100),                 -- 'Засувка', 'Норія'
    color     VARCHAR(7),                   -- '#4A90D9'
    icon      VARCHAR(50)                   -- назва іконки або SVG-ключ
);

-- Пристрої (вузли графу)
CREATE TABLE devices (
    id            SERIAL PRIMARY KEY,
    type_id       INT REFERENCES device_types(id),
    name          VARCHAR(100) NOT NULL,    -- 'Засувка №1'
    description   TEXT,
    pos_x         FLOAT,                   -- позиція на полотні
    pos_y         FLOAT
);

-- Порти пристроїв (входи/виходи)
CREATE TABLE ports (
    id          SERIAL PRIMARY KEY,
    device_id   INT REFERENCES devices(id) ON DELETE CASCADE,
    direction   VARCHAR(3) NOT NULL CHECK (direction IN ('in', 'out')),
    name        VARCHAR(100) NOT NULL,     -- 'Вихід на Транспортер №1'
    port_order  INT DEFAULT 0             -- порядок відображення
);

-- З'єднання між портами
CREATE TABLE connections (
    id          SERIAL PRIMARY KEY,
    source_port INT REFERENCES ports(id) ON DELETE CASCADE,
    target_port INT REFERENCES ports(id) ON DELETE CASCADE,
    UNIQUE(source_port, target_port)
);
```

---

## 5. Структура проекту

```
project/
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── nodes/
│   │   │   │   ├── DeviceNode.tsx       # Кастомний вузол з портами
│   │   │   │   └── NodeTypes.ts         # Реєстрація типів вузлів
│   │   │   ├── panels/
│   │   │   │   ├── Toolbar.tsx          # Панель додавання пристроїв
│   │   │   │   ├── NodeEditor.tsx       # Редактор властивостей вузла
│   │   │   │   └── SavePanel.tsx        # Кнопка збереження в БД
│   │   │   └── GraphEditor.tsx          # Головний компонент React Flow
│   │   ├── api/
│   │   │   └── client.ts               # HTTP клієнт до FastAPI
│   │   ├── types/
│   │   │   └── graph.ts                # TypeScript типи
│   │   └── App.tsx
│   └── package.json
│
└── backend/
    ├── main.py                          # FastAPI app
    ├── routers/
    │   ├── devices.py                   # CRUD для пристроїв
    │   ├── ports.py                     # CRUD для портів
    │   └── connections.py              # CRUD для з'єднань
    ├── models.py                        # Pydantic схеми
    ├── database.py                      # asyncpg підключення
    └── requirements.txt
```

---

## 6. Функціональні вимоги

### 6.1 Вузли (пристрої)

- **Типи вузлів**: засувка, норія, транспортер, редлер, бункер, силос (розширюваний список)
- **Кожен вузол відображає**:
  - Назву пристрою (наприклад, "Засувка №3")
  - Іменовані порти входів (ліворуч, синій)
  - Іменовані порти виходів (праворуч, зелений)
- **Дії з вузлом**:
  - Перетягування по полотну (drag & drop)
  - Подвійний клік — відкрити редактор властивостей
  - Додати/видалити порт
  - Перейменувати порт
  - Видалити вузол (з каскадним видаленням портів і з'єднань)

### 6.2 З'єднання

- З'єднання тільки від **output порту** до **input порту**
- Заборона петель (пристрій сам на себе)
- Заборона дублікатів з'єднань
- Клік на з'єднання — виділення і можливість видалення
- Відображення стрілки напрямку

### 6.3 Полотно

- Масштабування (zoom) і переміщення (pan)
- Мінімапа (minimap) для орієнтації на великих схемах
- Кнопки "fit to view" і "reset zoom"
- Горизонтальна або вертикальна сітка (grid snapping)

### 6.4 Збереження і завантаження

- **Кнопка "Зберегти в БД"** — відправляє весь граф у FastAPI, який робить upsert в PostgreSQL
- **Кнопка "Завантажити з БД"** — отримує граф і відновлює стан редактора
- **Кнопка "Експорт JSON"** — зберегти файл локально для бекапу
- **Автозбереження** в localStorage (щоб не втратити при перезавантаженні сторінки)

---

## 7. API ендпоінти (FastAPI)

```
GET    /api/graph              — отримати весь граф (devices + ports + connections)
POST   /api/graph              — зберегти весь граф (upsert)

GET    /api/device-types       — список типів пристроїв
GET    /api/devices            — список пристроїв
POST   /api/devices            — створити пристрій
PUT    /api/devices/{id}       — оновити
DELETE /api/devices/{id}       — видалити

POST   /api/ports              — додати порт
PUT    /api/ports/{id}
DELETE /api/ports/{id}

POST   /api/connections        — додати з'єднання
DELETE /api/connections/{id}
```

---

## 8. Формат JSON для обміну

```json
{
  "devices": [
    {
      "id": 1,
      "type": "zasuvka",
      "name": "Засувка №1",
      "pos_x": 250,
      "pos_y": 150,
      "ports": [
        { "id": 10, "direction": "in",  "name": "Вхід з елеватора", "order": 0 },
        { "id": 11, "direction": "out", "name": "Вихід на Транспортер №1", "order": 0 },
        { "id": 12, "direction": "out", "name": "Вихід на Редлер №17", "order": 1 },
        { "id": 13, "direction": "out", "name": "Вихід на Норію №2", "order": 2 }
      ]
    }
  ],
  "connections": [
    { "id": 1, "source_port": 11, "target_port": 20 },
    { "id": 2, "source_port": 12, "target_port": 31 }
  ]
}
```

---

## 9. Вигляд вузла (DeviceNode)

```
┌─────────────────────────────────┐
│  [іконка]  Засувка №1           │
├─────────────────────────────────┤
│ ●── Вхід з елеватора            │   ← input port (зліва)
├─────────────────────────────────┤
│          Вихід → Транспортер №1 ──●  ← output port (справа)
│          Вихід → Редлер №17     ──●
│          Вихід → Норія №2       ──●
└─────────────────────────────────┘
```

---

## 10. Поетапна реалізація

| Етап | Задачі | Результат |
|---|---|---|
| **1. БД** | Створити схему, наповнити типами пристроїв | PostgreSQL готова |
| **2. Бекенд** | FastAPI + GET/POST /api/graph | API повертає/зберігає граф |
| **3. Базовий редактор** | React Flow + кастомний DeviceNode з портами | Вузли з'являються на полотні |
| **4. Редактор вузла** | Панель властивостей (назва, порти) | Можна редагувати вузол |
| **5. Збереження** | Кнопка Save → POST /api/graph | Граф зберігається в БД |
| **6. Завантаження** | GET /api/graph → відновлення стану | Граф завантажується з БД |
| **7. UX-поліш** | Мінімапа, автозбереження, іконки типів | Готово до використання |

---

## 11. Залежності

### Frontend
```json
{
  "@xyflow/react": "^12",
  "react": "^18",
  "typescript": "^5",
  "zustand": "^4"
}
```

### Backend
```
fastapi==0.115
uvicorn==0.30
asyncpg==0.29
pydantic==2.7
python-dotenv==1.0
```
